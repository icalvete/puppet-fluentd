<source>
  type syslog
  port <%= @remote_port %>
  bind 0.0.0.0
  tag sp
  format none
</source>

<match sp.**>
  type rewrite_tag_filter
  rewriterule1 message frm frm
  rewriterule2 message ::apache apache
  rewriterule3 message ::php php
</match>

<match apache>
  type parser
  key_name message
  
  format /^(?<time>[^ ]*\s*[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?[^\:]*\: *:(?<environment>.*)::(?<application>[a-zA-Z0-9_\/\.\-]*)::(?<operation>.*?):\s(?<message>.*)$/
  add_prefix processed
</match>

<match php>
  type parser
  key_name message
  
  format /^(?<time>[^ ]*\s*[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?[^\:]*\: *:(?<environment>.*)::(?<application>[a-zA-Z0-9_\/\.\-]*)::(?<operation>.*?):\s(?<message>.*)$/
  add_prefix processed
</match>

<match frm>
  type parser
  key_name message

  format /^(?<time>[^ ]*\s*[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?[^\:]*\: *:(?<environment>.*)::(?<application>[a-zA-Z0-9_\/\.\-]*)::(?<operation>.*?):\s<frm><mac>(?<mac>[0-9]*)</mac><devid>(?<devid>.*)</devid><date>(?<date>[0-9 :-]*)<date><version>(?<version>[0-9\.]*)</version><ack><id_1>(?<id_1>.*)</id_1><pow_1>(?<pow_1>.*)</pow_1><temp_1>(?<temp_1>.*)</temp_1><state_1>(?<state_1>.*)</state_1></ack><ack><id_2>(?<id_2>.*)</id_2><pow_2>(?<pow_2>.*)</pow_2><temp_2>(?<temp_2>.*)</temp_2><state_2>(?<state_2>.*)</state_2></ack><ack><id_3>(?<id_3>.*)</id_3><pow_3>(?<pow_3>.*)</pow_3><temp_3>(?<temp_3>.*)</temp_3><state_3>(?<state_3>.*)</state_3></ack><ack><id_4>(?<id_4>.*)</id_4><pow_4>(?<pow_4>.*)</pow_4><temp_4>(?<temp_4>.*)</temp_4><state_4>(?<state_4>.*)</state_4></ack><ack><id_5>(?<id_5>.*)</id_5><pow_5>(?<pow_5>.*)</pow_5><temp_5>(?<temp_5>.*)</temp_5><state_5>(?<state_5>.*)</state_5></ack><ack><id_6>(?<id_6>.*)</id_6><pow_6>(?<pow_6>.*)</pow_6><temp_6>(?<temp_6>.*)</temp_6><state_6>(?<state_6>.*)</state_6></ack><ack><id_7>(?<id_7>.*)</id_7><pow_7>(?<pow_7>.*)</pow_7><temp_7>(?<temp_7>.*)</temp_7><state_7>(?<state_7>.*)</state_7></ack><ack><id_8>(?<id_8>.*)</id_8><pow_8>(?<pow_8>.*)</pow_8><temp_8>(?<temp_8>.*)</temp_8><state_8>(?<state_8>.*)</state_8></ack><ack><id_9>(?<id_9>.*)</id_9><pow_9>(?<pow_9>.*)</pow_9><temp_9>(?<temp_9>.*)</temp_9><state_9>(?<state_9>.*)</state_9><ack><ack><id_10>(?<id_9>.*)</id_10><pow_10>(?<pow_10>.*)</pow_10><temp_10>(?<temp_10>.*)</temp_10><state_10>(?<state_10>.*)</state_10></ack></frm>$/
  add_prefix processed
</match>

<match processed.*>
  type copy

  <store>
    type 		file
    path 		/var/log/td-agent/sp
    time_slice_format 	%Y%m%d
    time_slice_wait 	10m
    time_format 	%Y%m%dT%H%M%S%z
    compress 		gzip
    utc
   </store>

  <store>
    type		elasticsearch
    host		<%= scope.lookupvar('fluentd::td-agent::elasticsearch_host') %>
    port 		9200
    logstash_format 	true
    flush_interval      5s
  </store>
</match>
